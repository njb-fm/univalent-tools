#!/usr/bin/env bash

set -u
selected=""

function process_done() {
	echo -e "\nDone!!\nPress any key to continue..."
	read -n1 selected
}

function pkg_update() {
	clear
	sudo pacman -Syu
	process_done
	pkgmanage
}

function pkg_search() {
	clear
	SEARCHWORD=$(whiptail --nocancel --inputbox "Search word?" 0 0 3>&1 1>&2 2>&3)
	pacman -Ss ${SEARCHWORD}
	process_done
	pkgmanage
}

function pkg_details() {
	clear
	PKGNAME=$(whiptail --nocancel --inputbox "Package name?" 0 0 3>&1 1>&2 2>&3)
	pacman -Si ${PKGNAME}
	process_done
	pkgmanage
}

function pkg_install() {
	clear
	PKGNAME=$(whiptail --nocancel --inputbox "Package name?" 0 0 3>&1 1>&2 2>&3)
	sudo pacman -S ${PKGNAME}
	process_done
	pkgmanage
}

function pkg_remove() {
	clear
	PKGNAME=$(whiptail --nocancel --inputbox "Package name?" 0 0 3>&1 1>&2 2>&3)
	sudo pacman -Rs ${PKGNAME}
	process_done
	pkgmanage
}

function clean_cache () {
	clear
	sudo pacman -Scc
	process_done
	pkgmanage
}

function noneed_pkgs () {
	clear
	sudo pacman -Rns $(pacman -Qtdq)
	process_done
	pkgmanage
}

function pkgmanage () {
	clear
	pkg_run=$(whiptail --title "Package Management" --menu "" 0 0 0 --nocancel --notags 'pkg_update' "Update all packages" 'pkg_search' "Search packages" 'pkg_details' "Show package details" 'pkg_install' "Install Package" 'pkg_remove' "Remove Packages" 'noneed_pkgs' "Remove no-needed packages" 'clean_cache' "Clean caches" 'return' "Exit" 3>&1 1>&2 2>&3)
	${pkg_run}
}

function setntpdaemon () { 
	clear
	FILE="/etc/systemd/system/sysinit.target.wants/systemd-timesyncd.service"
	if [ -e ${FILE} ]; then
		sudo timedatectl set-ntp false
	else
		sudo timedatectl set-ntp true
	fi
	process_done
	time_settings
}

function select_timezone() {
	clear
	sudo ln -sf /usr/share/zoneinfo/$(tzselect) /etc/localtime
	sudo hwclock --systohc
	echo -e "\nPlease reboot for changes to take effect."
	process_done
	time_settings
}

function ntp_sync() {
	clear
	sudo ntpdate pool.ntp.org
	process_done
	time_settings
}

function systohc() {
	clear
	sudo hwclock --systohc
	process_done
	time_settings
}

function time_settings () {
	clear
	FILE="/etc/systemd/system/dbus-org.freedesktop.timesync1.service"
	if [ -e ${FILE} ]; then
		NTPD="Disable"
	else
		NTPD="Enable"
	fi
	time_run=$(whiptail --title "Time Settings" --menu "" 0 0 0 --nocancel --notags 'select_timezone' "Select time zone" 'ntp_sync' "Sync time with NTP" 'systohc' "Write to hardware clock" 'setntpdaemon' "${NTPD} NTP autosync" 'return' "Exit" 3>&1 1>&2 2>&3)
	${time_run}
}

function main () {
	clear
	main_run=$(whiptail --title "Univalent Hello" --menu "" 0 0 0 --nocancel --notags 'nmtui' "Network" 'alsamixer' "Sound" 'pkgmanage' "Package Management" 'time_settings' "Time settings" 'exit 0' "Exit" 3>&1 1>&2 2>&3)
	${main_run}
}

while true; do
	main
done

